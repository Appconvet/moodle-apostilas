<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizador de PDFs</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background-color: #fff;
        padding: 20px;
        color: #333;
      }
      body.blocked * {
        pointer-events: none !important;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
      }
      .card {
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      .thumbnail {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }
      .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .pdf-icon {
        font-size: 48px;
        color: #f44336;
      }
      .card-content {
        padding: 12px;
      }
      .card-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        /*white-space: nowrap;*/
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card-details {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #5f6368;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        display: grid;
        gap: 2rem;
        background: #ffffff;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(20px);
        transition: transform 0.3s;
      }
      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }
      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
      }
      .modal-messages {
        margin-top: 20px;
        min-height: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .modal-message {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        margin: 0;
        font-size: 14px;
        color: #555;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s, transform 0.5s;
      }
      .modal-message.active {
        opacity: 1;
        transform: translateY(0);
      }

      /* Spinner Styles */
      .sk-chase {
        width: 40px;
        height: 40px;
        position: relative;
        margin: 0 auto;
        animation: sk-chase 2.5s infinite linear both;
      }
      .sk-chase-dot {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        animation: sk-chase-dot 2s infinite ease-in-out both;
      }
      .sk-chase-dot:before {
        content: "";
        display: block;
        width: 25%;
        height: 25%;
        background-color: #2f4e13;
        border-radius: 100%;
        animation: sk-chase-dot-before 2s infinite ease-in-out both;
      }
      .sk-chase-dot:nth-child(1) {
        animation-delay: -1.1s;
      }
      .sk-chase-dot:nth-child(2) {
        animation-delay: -1s;
      }
      .sk-chase-dot:nth-child(3) {
        animation-delay: -0.9s;
      }
      .sk-chase-dot:nth-child(4) {
        animation-delay: -0.8s;
      }
      .sk-chase-dot:nth-child(5) {
        animation-delay: -0.7s;
      }
      .sk-chase-dot:nth-child(6) {
        animation-delay: -0.6s;
      }
      .sk-chase-dot:nth-child(1):before {
        animation-delay: -1.1s;
      }
      .sk-chase-dot:nth-child(2):before {
        animation-delay: -1s;
      }
      .sk-chase-dot:nth-child(3):before {
        animation-delay: -0.9s;
      }
      .sk-chase-dot:nth-child(4):before {
        animation-delay: -0.8s;
      }
      .sk-chase-dot:nth-child(5):before {
        animation-delay: -0.7s;
      }
      .sk-chase-dot:nth-child(6):before {
        animation-delay: -0.6s;
      }
      @keyframes sk-chase {
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes sk-chase-dot {
        80%,
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes sk-chase-dot-before {
        50% {
          transform: scale(0.4);
        }
        100%,
        0% {
          transform: scale(1);
        }
      }

      @media (max-width: 768px) {
        .cards-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="cards-grid" class="cards-grid">
        <!-- Cards serão gerados dinamicamente -->
      </div>
    </div>

    <!-- Modal de Loading -->
    <div id="loadingModal" class="modal-overlay">
      <div class="modal-content">
        <h3 class="modal-title">Preparando seu download</h3>
        <div class="sk-chase">
          <div class="sk-chase-dot"></div>
          <div class="sk-chase-dot"></div>
          <div class="sk-chase-dot"></div>
          <div class="sk-chase-dot"></div>
          <div class="sk-chase-dot"></div>
          <div class="sk-chase-dot"></div>
        </div>
        <div class="modal-messages">
          <div id="message1" class="modal-message">
            Carregando informações do aluno...
          </div>
          <div id="message2" class="modal-message">Inserindo nome e CPF...</div>
          <div id="message3" class="modal-message">
            Rastreando IP do aluno...
          </div>
          <div id="message4" class="modal-message">Encriptando PDF...</div>
          <div id="message5" class="modal-message" style="display: none">
            Finalizando download...
          </div>
        </div>
      </div>
    </div>

    <script>
      // Variável global para o elemento
      let cardsGrid;
      // Variável para controlar o estado de download
      let isDownloading = false;
      // Referência ao modal
      let loadingModal;
      // Array de mensagens
      let messages;
      // Interval para animação das mensagens
      let messageInterval;

      // Função para obter parâmetros da URL
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Usar os parâmetros
      const folderName = getUrlParameter("folderName") || "";
      const userName = getUrlParameter("nome");
      const userCpf = getUrlParameter("cpf");
      const driveType = getUrlParameter("drive"); // "preparatorio" ou "treinamentos"

      console.log("Parâmetros obtidos:", {
        folderName,
        userName,
        userCpf,
        driveType,
      });

      // Determinar a URL base baseada no parâmetro drive
      function getBaseUrl() {
        if (driveType === "treinamentos") {
          return "https://n8n.convet.com.br/webhook/treinamentos/";
        } else {
          return "https://n8n.convet.com.br/webhook/preparatorio/";
        }
      }

      const baseUrl = getBaseUrl();
      console.log("URL base selecionada:", baseUrl);

      function formatDate(dateString) {
        const options = { day: "2-digit", month: "2-digit", year: "numeric" };
        return new Date(dateString).toLocaleDateString("pt-BR", options);
      }

      function extractFileId(url) {
        const match = url.match(/\/d\/([^\/]+)/);
        return match ? match[1] : null;
      }

      // Função para ativar/desativar o estado de bloqueio
      function setDownloadState(downloading) {
        isDownloading = downloading;
        if (downloading) {
          document.body.classList.add("blocked");
        } else {
          document.body.classList.remove("blocked");
        }
      }

      // Funções para controlar o modal de loading
      function showLoadingModal() {
        loadingModal.classList.add("active");

        // Resetar mensagens
        messages.forEach((message) => {
          message.classList.remove("active");
          message.style.display = "block";
        });

        // Esconder a mensagem de finalização
        messages[4].style.display = "none";

        // Iniciar animação das mensagens
        let currentMessage = 0;
        clearInterval(messageInterval);

        messageInterval = setInterval(() => {
          if (currentMessage > 0) {
            messages[currentMessage - 1].classList.remove("active");
          }

          if (currentMessage < messages.length - 1) {
            messages[currentMessage].classList.add("active");
            currentMessage++;
          } else {
            // Para na mensagem 4 (Encriptando PDF) e fica nela
            messages[3].classList.add("active");
          }
        }, 2000); // Aumentei para 2 segundos entre as mensagens
      }

      function showFinalMessage() {
        clearInterval(messageInterval);

        // Esconder todas as mensagens
        messages.forEach((message) => {
          message.classList.remove("active");
        });

        // Mostrar apenas a mensagem de finalização
        messages[4].style.display = "block";
        messages[4].classList.add("active");
      }

      function hideLoadingModal() {
        loadingModal.classList.remove("active");
        clearInterval(messageInterval);
      }

      async function loadThumbnail(card, fileId, fileName) {
        try {
          // requisicao ao n8n - get thumb
          // const response = await fetch(`${baseUrl}thumbnail`, {
          //   method: "POST",
          //   headers: {
          //     "Content-Type": "application/json",
          //   },
          //   body: JSON.stringify({ fileId: fileId }),
          // });
          // const data = await response.json();
          // if (data[0] && data[0].thumbnailUrl) {
          //   const thumbnailDiv = card.querySelector(".thumbnail");
          //   thumbnailDiv.innerHTML = `<img src="${data[0].thumbnailUrl}" alt="${fileName}"
          //       onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\"pdf-icon\"></div>`;
          // }
          const thumbnailDiv = card.querySelector(".thumbnail");
          thumbnailDiv.innerHTML = `<img src="./folder.png" alt="${fileName}" 
                onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\"pdf-icon\"></div>`;
        } catch (error) {
          console.warn("Erro ao carregar thumbnail:", error);
        }
      }

      async function fetchPdfFiles() {
        console.log("Buscando arquivos na pasta:", folderName);
        console.log(
          "Usando URL:",
          `${baseUrl}folder-files?folderName=${encodeURIComponent(folderName)}`
        );

        try {
          const res = await fetch(
            `${baseUrl}folder-files?folderName=${encodeURIComponent(
              folderName
            )}`
          );

          if (!res.ok) {
            console.error("Erro na resposta:", res.status);
            return [];
          }

          const data = await res.json();
          return data[0]?.files || [];
        } catch (error) {
          console.error("Erro ao buscar arquivos:", error);
          return [];
        }
      }

      function createCards(pdfFiles) {
        // Verifica se o elemento existe
        if (!cardsGrid) {
          console.error("Elemento cards-grid não encontrado");
          return;
        }

        // Limpa o conteúdo anterior
        cardsGrid.innerHTML = "";

        if (pdfFiles.length === 0) {
          cardsGrid.innerHTML =
            '<p style="grid-column: 1/-1; text-align: center; padding: 20px;">Nenhum arquivo encontrado</p>';
          return;
        }

        pdfFiles.forEach((file, index) => {
          if (!file.webViewLink) {
            console.warn("Arquivo sem webViewLink:", file.name);
            return;
          }

          const fileId = extractFileId(file.webViewLink);
          if (!fileId) {
            console.warn("Não foi possível extrair fileId:", file.webViewLink);
            return;
          }

          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-id", file.id);

          card.innerHTML = `
        <div class="thumbnail">
            <div class="pdf-icon"></div> <!-- Placeholder -->
        </div>
        <div class="card-content">
            <div class="card-title" title="${file.name}">${file.name}</div>
            <div class="card-details">
                <span>${formatDate(file.modifiedTime)}</span>
                <span>PDF</span>
            </div>
        </div>
    `;

          // Carrega a thumbnail assinada
          loadThumbnail(card, fileId, file.name);

          card.addEventListener("click", () => {
            // Verifica se já está em processo de download
            if (isDownloading) {
              console.log("Download em andamento, clique bloqueado");
              return;
            }
            console.log("Download com watermark:", file.name);
            downloadWithWatermark(file.id, file.name);
          });

          cardsGrid.appendChild(card);
        });
      }

      async function downloadWithWatermark(folderId, fileName) {
        setDownloadState(true);
        showLoadingModal();

        try {
          const res = await fetch(`${baseUrl}watermark`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderId, name: userName, cpf: userCpf }),
          });

          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

          // Método alternativo: converter para blob diretamente
          const blob = await res.blob();

          if (blob.size === 0) {
            throw new Error("Arquivo veio vazio do servidor");
          }

          console.log("Blob size:", blob.size);

          // Mostra a mensagem de finalização antes de baixar
          showFinalMessage();

          // Pequeno delay para mostrar a mensagem de finalização
          await new Promise((resolve) => setTimeout(resolve, 1500));

          // Força o download
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${fileName.replace(/\.pdf$/i, "")}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Erro:", error);
          alert(`Falha no download: ${error.message}`);
        } finally {
          setDownloadState(false);
          hideLoadingModal();
        }
      }

      // Lifecycle corrigido
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("DOM Carregado");

        // Inicializa o elemento após o DOM estar pronto
        cardsGrid = document.getElementById("cards-grid");
        loadingModal = document.getElementById("loadingModal");

        // Inicializa as mensagens
        messages = [
          document.getElementById("message1"),
          document.getElementById("message2"),
          document.getElementById("message3"),
          document.getElementById("message4"),
          document.getElementById("message5"),
        ];

        if (!cardsGrid) {
          console.error("Elemento #cards-grid não encontrado no DOM");
          return;
        }

        // Adiciona loading state
        cardsGrid.innerHTML =
          '<p style="grid-column: 1/-1; text-align: center; padding: 20px;">Carregando arquivos...</p>';

        try {
          const pdfFiles = await fetchPdfFiles();
          createCards(pdfFiles);
        } catch (error) {
          console.error("Erro no lifecycle:", error);
          cardsGrid.innerHTML =
            '<p style="grid-column: 1/-1; text-align: center; padding: 20px; color: red;">Erro ao carregar arquivos</p>';
        }
      });

      // Fallback: tenta inicializar quando a window carregar completamente
      window.addEventListener("load", () => {
        console.log("Window totalmente carregada");
      });
    </script>
  </body>
</html>
